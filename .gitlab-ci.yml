# ⚠️ OPTIMIZED FOR FREE TIER - Limited CI/CD minutes
# This pipeline only runs Docker build (via Dockerfile multi-stage build)
# which includes Java compilation + React build
# ✅ Tests run locally before push: ./gradlew test

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
  DOCKER_IMAGE_TAG: $CI_COMMIT_SHA

stages:
  - package

# ✅ Docker build includes all compilation and frontend build (Dockerfile multi-stage)
# ✅ This uses ~3-5 minutes vs 20+ minutes for separate jobs
package_docker:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    FF_USE_FASTZIP: "true"
    TRANSFER_METER_FREQUENCY: "5s"
    ARTIFACT_COMPRESSION_LEVEL: "fastest"
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG -t $DOCKER_IMAGE_NAME:latest .
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
    - docker push $DOCKER_IMAGE_NAME:latest
  only:
    - main

deploy_to_railway:
  stage: package
  image: alpine:latest
  script:
    - echo "SUCCESS - Docker image built and pushed"
    - echo "Image available at:"
    - echo "  $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG"
    - echo "  $DOCKER_IMAGE_NAME:latest"
    - echo ""
    - echo "To deploy to Railway:"
    - echo "  1. Visit https://railway.app"
    - echo "  2. Connect your GitLab repository"
    - echo "  3. Add PostgreSQL service"
    - echo "  4. Railway auto-deploys on push"
    - echo ""
    - echo "See: DEPLOY_TO_RAILWAY.md"
  only:
    - main
  when: manual
