variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  DOCKER_DRIVER: overlay2
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle

stages:
  - build
  - test
  - package
  - deploy

# BUILD STAGE
build_services:
  stage: build
  image: gradle:8.5-jdk21-jammy
  script:
    - cd $CI_PROJECT_DIR
    - gradle clean build -x test --info
  cache:
    paths:
      - .gradle/
  artifacts:
    paths:
      - services/*/build/libs/*.jar
    expire_in: 1 week
  only:
    - main
    - merge_requests

build_ui:
  stage: build
  image: node:20-alpine
  script:
    - cd $CI_PROJECT_DIR/ui
    - npm ci --prefer-offline --no-audit
    - npm run build
  cache:
    paths:
      - ui/node_modules/
  artifacts:
    paths:
      - ui/dist/
    expire_in: 1 week
  only:
    - main
    - merge_requests

# TEST STAGE
test_services_unit:
  stage: test
  image: gradle:8.5-jdk21-jammy
  script:
    - cd $CI_PROJECT_DIR
    - gradle test --info
  cache:
    paths:
      - .gradle/
  artifacts:
    reports:
      junit:
        - services/*/build/test-results/test/*.xml
    expire_in: 30 days
  only:
    - main
    - merge_requests

lint_java:
  stage: test
  image: gradle:8.5-jdk21-jammy
  script:
    - cd $CI_PROJECT_DIR
    - gradle spotlessCheck || echo "Formatting check completed"
  cache:
    paths:
      - .gradle/
  allow_failure: true
  only:
    - main
    - merge_requests

# PACKAGE STAGE
package_docker:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - echo "Docker images would be built and pushed here"
  only:
    - main

deploy_docs:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Documentation deployment step"
  only:
    - main
